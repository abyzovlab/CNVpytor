name: Test python versions

on: [push]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.3", "3.4", "3.5", "3.6", "3.7", "3.8", "3.9", "3.10", "3.11", "3.12"]

    runs-on: |
      ${{ contains('3.3 3.4 3.5 3.6', matrix.python-version) ? 'ubuntu-20.04' : 'ubuntu-latest' }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install .

    - name: cnvpytor Usage
      run: |
        cnvpytor -h

    - name: Install `gcsfuse`
      run: |
        echo "deb http://packages.cloud.google.com/apt gcsfuse-$(lsb_release -c -s) main" | sudo tee /etc/apt/sources.list.d/gcsfuse.list
        curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /tmp/packages-cloud-google-com-apt-keyring.gpg
        sudo mv /tmp/packages-cloud-google-com-apt-keyring.gpg /etc/apt/trusted.gpg.d/
        sudo apt-get update
        sudo apt-get install gcsfuse -y

    - name: Mount Google Cloud Storage bucket
      run: |
        sudo mkdir -p /mnt/gcs-bucket
        sudo chown $USER:$USER /mnt/gcs-bucket
        gcsfuse --implicit-dirs --anonymous-access --only-dir platinum-genomes genomics-public-data /mnt/gcs-bucket

    - name: List bucket contents
      run: ls /mnt/gcs-bucket

    - name: run cnvpytor RD
      run: |
        cnvpytor -root test.pytor -rd /mnt/gcs-bucket/bam/NA12877_S1.bam -v d

    - name: run cnvpytor SNP
      run: |
        cnvpytor -root test.pytor -snp /mnt/gcs-bucket/vcf/NA12877_S1.genome.vcf -v d

    - name: run cnvpytor mask_snps
      run: |
        cnvpytor -root test.pytor -mask_snps

    - name: run cnvpytor pileup
      run: |
        cnvpytor -root test.pytor -pileup /mnt/gcs-bucket/bam/NA12877_S1.bam -v d

    - name: run cnvpytor his, baf
      run: |
        cnvpytor -root test.pytor -his 100000 -v d
        cnvpytor -root test.pytor -baf 100000 -v d 

    - name: run cnvpytor call combined
      run: |
        cnvpytor -root test.pytor -call combined 100000 -v d > output_2D.tsv
        cat output_2D.tsv

    - name: check combined calls
      run: |
        md5sum output_2D.tsv
        [ "$(md5sum output_2D.tsv | awk '{ print $1 }')" == "c7a07af67cb38337f5df012cef304e66" ] && echo PASS || echo FAIL

    - name: run cnvpytor call meanShift
      run: |
        cnvpytor -root test.pytor -partition 100000 -v d
        cnvpytor -root test.pytor -call 100000 -v d > output_meanShift.tsv
        cat output_meanShift.tsv

    - name: check meanShift calls
      run: |
        md5sum output_meanShift.tsv
        
        [ "$(md5sum output_meanShift.tsv | awk '{ print $1 }')" == "7dd1d5297e57ae1a89f0d58c2a604bb6" ] && echo PASS || echo FAIL

    - name: run cnvptor ls
      run: |
        cnvpytor -root test.pytor -ls

    - name: run cnvptor rdstat
      run: |
        echo "rdstat" | cnvpytor -root test.pytor -view 100000 -o NA12877.png

    - name: run cnvptor manhattan
      run: |
        echo -e "set panels rd likelihood\n manhattan" | cnvpytor -root test.pytor  -view 100000 -o NA12877.png

    - name: Upload data
      uses: actions/upload-artifact@v4
      with:
        name: NA12877 Python ${{ matrix.python-version }}
        path: |
          output_2D.tsv
          output_meanShift.tsv
          NA12877.stat.0000.png
          NA12877.global.0000.png
